#!/usr/bin/env python3
import argparse
import sys

def c14n_bytes(path: str) -> bytes:
    from lxml import etree
    parser = etree.XMLParser(remove_blank_text=True, resolve_entities=False, no_network=True)
    tree = etree.parse(path, parser)
    # Exclusive C14N is typically the most stable for diffs
    return etree.tostring(tree, method="c14n", exclusive=True, with_comments=False)

def main() -> int:
    ap = argparse.ArgumentParser()
    ap.add_argument("ref")
    ap.add_argument("out")
    args = ap.parse_args()

    try:
        a = c14n_bytes(args.ref)
        b = c14n_bytes(args.out)
    except Exception as e:
        print(f"[compare_xml] parse/c14n error: {e}", file=sys.stderr)
        return 2

    if a != b:
        print("[compare_xml] FAIL: XML differs after canonicalization")
        return 1

    print("[compare_xml] OK")
    return 0

if __name__ == "__main__":
    raise SystemExit(main())
